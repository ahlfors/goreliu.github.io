
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="goreliu" />
        <meta name="description" content="简介 Apache Drill是一个低延迟的分布式海量数据（涵盖结构化、半结构化以及嵌套数据）交互式查询引擎，使用ANSI SQL兼容语法，支持本地文件、HDFS、HBase、MongoDB等后端存储，支持Parquet、JSON、CSV、TSV、PSV等数据格式。受Google的Dremel启发，Drill满足上千节点的PB级别数据的交互式商业智能分析场景。 安装 Drill可以安装在单机或者集群环境上，支持Linux、Windows、Mac OS X系统。简单起见，我们在Linux单机环境（CentOS 6.3）搭建以供试用。 准备安装包： jdk 7：jdk-7u75-linux-x64.tar.gz Drill：apache-drill-0.8.0.tar.gz 在$WORK（/path/to/work）目录中安装 …" />


    <title>Apache Drill 学习笔记一：环境搭建和简单试用 - 陌辞寒</title>

        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css" />

    <link href="/theme/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/theme/css/pygments/default.css" rel="stylesheet" />
    
    <link href="/theme/css/pelican-twitchy.min.css" rel="stylesheet" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <!-- Feeds -->
        <link href="/theme/css/github.css" rel="stylesheet" />
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="" title="陌辞寒" class="collapsed">
            <span class="fa fa-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="/archives.html" title="Recent Articles" class="collapsed">
            <span class="fa fa-list-ul"></span>
        </a>
    </li>
                
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fa fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </div>
        <div id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/">
                            <span class="fa fa-home padding-small"></span>
                            陌辞寒
                    </a>
                </li>
                    <li>
                        <a href="/archives.html">
                            <span class="fa fa-list-ul padding-small"></span>
                            最近
                        </a>
                    </li>
                
                
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fa fa-folder-open padding-small"></i>
                        分类
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li >
                        <a href="/category/ahk.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            AHK
                            <span class="badge pull-right categorybadge">15</span>
                        </a>
                    </li>
                    <li >
                        <a href="/category/cao-gao.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            草稿
                            <span class="badge pull-right categorybadge">28</span>
                        </a>
                    </li>
                    <li >
                        <a href="/category/du-shu.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            读书
                            <span class="badge pull-right categorybadge">6</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="/category/it.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            IT
                            <span class="badge pull-right categorybadge">26</span>
                        </a>
                    </li>
                    <li >
                        <a href="/category/sui-bi.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            随笔
                            <span class="badge pull-right categorybadge">20</span>
                        </a>
                    </li>
                </ul></li>
                
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <a href="#menu-toggle" class="btn btn-default" id="menu-toggle">
            <span id="right-arrow" class="fa fa-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="fa fa-chevron-left" title="minimize sidebar"></span>
        </a>
       <!-- /open/close sidebar -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-9">
                <header class="page-header">
                    <h2>
                        <a href="/apache-drill-xue-xi-bi-ji-yi-huan-jing-da-jian-he-jian-dan-shi-yong.html"
                           rel="bookmark"
                           title="Permalink to Apache Drill 学习笔记一：环境搭建和简单试用">
                            Apache Drill 学习笔记一：环境搭建和简单试用
                        </a>
                        <br>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2015-05-08T21:00:00+08:00"> 2015-05-08 21:00</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="/category/it.html">IT</a>
            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h2>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-9">
                <div class="entry-content">
                    <h2>简介</h2>
<p>Apache Drill是一个低延迟的分布式海量数据（涵盖结构化、半结构化以及嵌套数据）交互式查询引擎，使用ANSI SQL兼容语法，支持本地文件、HDFS、HBase、MongoDB等后端存储，支持Parquet、JSON、CSV、TSV、PSV等数据格式。受Google的Dremel启发，Drill满足上千节点的PB级别数据的交互式商业智能分析场景。</p>
<h2>安装</h2>
<p>Drill可以安装在单机或者集群环境上，支持Linux、Windows、Mac OS X系统。简单起见，我们在Linux单机环境（CentOS 6.3）搭建以供试用。</p>
<p>准备安装包：</p>
<ul>
<li>jdk 7：<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html">jdk-7u75-linux-x64.tar.gz</a> </li>
<li>Drill：<a href="http://getdrill.org/drill/download/apache-drill-0.8.0.tar.gz">apache-drill-0.8.0.tar.gz</a> </li>
</ul>
<p>在$WORK（/path/to/work）目录中安装，将jdk和drill分别解压到java和drill目录中，并打软连以便升级：</p>
<div class="highlight"><pre><span></span>.
├── drill
│   ├── apache-drill -&gt; apache-drill-0.8.0
│   └── apache-drill-0.8.0
├── init.sh
└── java
    ├── jdk -&gt; jdk1.7.0_75
    └── jdk1.7.0_75
</pre></div>


<p>并添加一init.sh脚本初始化java相关环境变量：</p>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">WORK</span><span class="o">=</span><span class="s2">&quot;/path/to/work&quot;</span>
<span class="nb">export</span> <span class="nv">JAVA</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$WORK</span><span class="s2">/java/jdk/bin/java&quot;</span>
<span class="nb">export</span> <span class="nv">JAVA_HOME</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$WORK</span><span class="s2">/java/jdk&quot;</span>
</pre></div>


<h2>启动</h2>
<p>在单机环境运行只需要启动bin/sqlline便可：</p>
<div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$WORK</span>
$ . ./init.sh
$ ./drill/apache-drill/bin/sqlline -u jdbc:drill:zk<span class="o">=</span><span class="nb">local</span>
Drill log directory /var/log/drill does not exist or is not writable, defaulting to ...
Apr <span class="m">06</span>, <span class="m">2015</span> <span class="m">12</span>:47:30 AM org.glassfish.jersey.server.ApplicationHandler initialize
INFO: Initiating Jersey application, version Jersey: <span class="m">2</span>.8 <span class="m">2014</span>-04-29 <span class="m">01</span>:25:26...
sqlline version <span class="m">1</span>.1.6
<span class="m">0</span>: jdbc:drill:zk<span class="o">=</span>local&gt; 
</pre></div>


<p><code>-u jdbc:drill:zk=local</code>表示使用本机的Drill，无需启动ZooKeeper，如果是集群环境则需要配置和启动ZooKeeper并填写地址。启动后便可以在<code>0: jdbc:drill:zk=local&gt;</code>后敲入命令使用了。</p>
<h2>试用</h2>
<p>Drill的sample-data目录有Parquet格式的演示数据可供查询：</p>
<div class="highlight"><pre><span></span><span class="mi">0</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">drill</span><span class="o">:</span><span class="n">zk</span><span class="o">=</span><span class="n">local</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">dfs</span><span class="o">.</span><span class="err">`</span><span class="sr">/path/to/work/drill/apache-drill/sample-data/</span><span class="n">nation</span><span class="o">.</span><span class="na">parquet</span><span class="err">`</span> <span class="n">limit</span> <span class="mi">5</span><span class="o">;</span>
<span class="o">+-------------+------------+-------------+------------+</span>
<span class="o">|</span> <span class="n">N_NATIONKEY</span> <span class="o">|</span>   <span class="n">N_NAME</span>   <span class="o">|</span> <span class="n">N_REGIONKEY</span> <span class="o">|</span> <span class="n">N_COMMENT</span>  <span class="o">|</span>
<span class="o">+-------------+------------+-------------+------------+</span>
<span class="o">|</span> <span class="mi">0</span>           <span class="o">|</span> <span class="n">ALGERIA</span>    <span class="o">|</span> <span class="mi">0</span>           <span class="o">|</span>  <span class="n">haggle</span><span class="o">.</span> <span class="n">carefully</span> <span class="n">f</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">1</span>           <span class="o">|</span> <span class="n">ARGENTINA</span>  <span class="o">|</span> <span class="mi">1</span>           <span class="o">|</span> <span class="n">al</span> <span class="n">foxes</span> <span class="n">promise</span> <span class="n">sly</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span>           <span class="o">|</span> <span class="n">BRAZIL</span>     <span class="o">|</span> <span class="mi">1</span>           <span class="o">|</span> <span class="n">y</span> <span class="n">alongside</span> <span class="n">of</span> <span class="n">the</span> <span class="n">p</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>           <span class="o">|</span> <span class="n">CANADA</span>     <span class="o">|</span> <span class="mi">1</span>           <span class="o">|</span> <span class="n">eas</span> <span class="n">hang</span> <span class="n">ironic</span><span class="o">,</span> <span class="n">sil</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">4</span>           <span class="o">|</span> <span class="n">EGYPT</span>      <span class="o">|</span> <span class="mi">4</span>           <span class="o">|</span> <span class="n">y</span> <span class="n">above</span> <span class="n">the</span> <span class="n">carefull</span> <span class="o">|</span>
<span class="o">+-------------+------------+-------------+------------+</span>
<span class="mi">5</span> <span class="n">rows</span> <span class="n">selected</span> <span class="o">(</span><span class="mf">0.741</span> <span class="n">seconds</span><span class="o">)</span>
</pre></div>


<p>这里用的库名格式为dfs.`本地文件（Parquet、JSON、CSV等文件）绝对路径`。可以看出只要熟悉SQL语法几乎没有学习成本。但Parquet格式文件需要专用工具查看、编辑，不是很方便，后续再专门介绍，下文先使用更通用的CSV和JSON文件进行演示。</p>
<p>在<code>$WORK/data</code>中创建如下<code>test.csv</code>文件：</p>
<div class="highlight"><pre><span></span><span class="m">1101</span>,SteveEurich,Steve,Eurich,16,StoreT
<span class="m">1102</span>,MaryPierson,Mary,Pierson,16,StoreT
<span class="m">1103</span>,LeoJones,Leo,Jones,16,StoreTem
<span class="m">1104</span>,NancyBeatty,Nancy,Beatty,16,StoreT
<span class="m">1105</span>,ClaraMcNight,Clara,McNight,16,Store
</pre></div>


<p>然后查询：</p>
<div class="highlight"><pre><span></span><span class="mi">0</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">drill</span><span class="o">:</span><span class="n">zk</span><span class="o">=</span><span class="n">local</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">dfs</span><span class="o">.</span><span class="err">`</span><span class="sr">/path/to/work/drill/data/</span><span class="n">test</span><span class="o">.</span><span class="na">csv</span><span class="err">`</span><span class="o">;</span>
<span class="o">+------------+</span>
<span class="o">|</span>  <span class="n">columns</span>   <span class="o">|</span>
<span class="o">+------------+</span>
<span class="o">|</span> <span class="o">[</span><span class="s2">&quot;1101&quot;</span><span class="o">,</span><span class="s2">&quot;SteveEurich&quot;</span><span class="o">,</span><span class="s2">&quot;Steve&quot;</span><span class="o">,</span><span class="s2">&quot;Eurich&quot;</span><span class="o">,</span><span class="s2">&quot;16&quot;</span><span class="o">,</span><span class="s2">&quot;StoreT&quot;</span><span class="o">]</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">[</span><span class="s2">&quot;1102&quot;</span><span class="o">,</span><span class="s2">&quot;MaryPierson&quot;</span><span class="o">,</span><span class="s2">&quot;Mary&quot;</span><span class="o">,</span><span class="s2">&quot;Pierson&quot;</span><span class="o">,</span><span class="s2">&quot;16&quot;</span><span class="o">,</span><span class="s2">&quot;StoreT&quot;</span><span class="o">]</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">[</span><span class="s2">&quot;1103&quot;</span><span class="o">,</span><span class="s2">&quot;LeoJones&quot;</span><span class="o">,</span><span class="s2">&quot;Leo&quot;</span><span class="o">,</span><span class="s2">&quot;Jones&quot;</span><span class="o">,</span><span class="s2">&quot;16&quot;</span><span class="o">,</span><span class="s2">&quot;StoreTem&quot;</span><span class="o">]</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">[</span><span class="s2">&quot;1104&quot;</span><span class="o">,</span><span class="s2">&quot;NancyBeatty&quot;</span><span class="o">,</span><span class="s2">&quot;Nancy&quot;</span><span class="o">,</span><span class="s2">&quot;Beatty&quot;</span><span class="o">,</span><span class="s2">&quot;16&quot;</span><span class="o">,</span><span class="s2">&quot;StoreT&quot;</span><span class="o">]</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">[</span><span class="s2">&quot;1105&quot;</span><span class="o">,</span><span class="s2">&quot;ClaraMcNight&quot;</span><span class="o">,</span><span class="s2">&quot;Clara&quot;</span><span class="o">,</span><span class="s2">&quot;McNight&quot;</span><span class="o">,</span><span class="s2">&quot;16&quot;</span><span class="o">,</span><span class="s2">&quot;Store&quot;</span><span class="o">]</span> <span class="o">|</span>
<span class="o">+------------+</span>
<span class="mi">5</span> <span class="n">rows</span> <span class="n">selected</span> <span class="o">(</span><span class="mf">0.082</span> <span class="n">seconds</span><span class="o">)</span>
</pre></div>


<p>可以看到结果和之前的稍有不同，因为CSV文件没有地方存放列列名，所以统一用<code>columns</code>代替，如果需要具体制定列则需要用<code>columns[n]</code>，如：</p>
<div class="highlight"><pre><span></span><span class="mi">0</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">drill</span><span class="o">:</span><span class="n">zk</span><span class="o">=</span><span class="n">local</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">columns</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">columns</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="n">from</span> <span class="n">dfs</span><span class="o">.</span><span class="err">`</span><span class="sr">/path/to/work/drill/data/</span><span class="n">test</span><span class="o">.</span><span class="na">csv</span><span class="err">`</span><span class="o">;</span>
<span class="o">+------------+------------+</span>
<span class="o">|</span>   <span class="n">EXPR$0</span>   <span class="o">|</span>   <span class="n">EXPR$1</span>   <span class="o">|</span>
<span class="o">+------------+------------+</span>
<span class="o">|</span> <span class="mi">1101</span>       <span class="o">|</span> <span class="n">Eurich</span>     <span class="o">|</span>
<span class="o">|</span> <span class="mi">1102</span>       <span class="o">|</span> <span class="n">Pierson</span>    <span class="o">|</span>
<span class="o">|</span> <span class="mi">1103</span>       <span class="o">|</span> <span class="n">Jones</span>      <span class="o">|</span>
<span class="o">|</span> <span class="mi">1104</span>       <span class="o">|</span> <span class="n">Beatty</span>     <span class="o">|</span>
<span class="o">|</span> <span class="mi">1105</span>       <span class="o">|</span> <span class="n">McNight</span>    <span class="o">|</span>
<span class="o">+------------+------------+</span>
</pre></div>


<p>CSV文件格式比较简单，发挥不出Drill的强大优势，下边更复杂的功能使用和Parquet更接近的JSON文件进行演示。</p>
<p>在<code>$WORK/data</code>中创建如下<code>test.json</code>文件：</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;ka1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;kb1&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>
  <span class="nt">&quot;kc1&quot;</span><span class="p">:</span> <span class="s2">&quot;vc11&quot;</span><span class="p">,</span>
  <span class="nt">&quot;kd1&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;ka2&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="nt">&quot;kb2&quot;</span><span class="p">:</span> <span class="mf">10.1</span><span class="p">,</span>
      <span class="nt">&quot;kc2&quot;</span><span class="p">:</span> <span class="s2">&quot;vc1010&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="nt">&quot;ka1&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&quot;kb1&quot;</span><span class="p">:</span> <span class="mf">2.2</span><span class="p">,</span>
  <span class="nt">&quot;kc1&quot;</span><span class="p">:</span> <span class="s2">&quot;vc22&quot;</span><span class="p">,</span>
  <span class="nt">&quot;kd1&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;ka2&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
      <span class="nt">&quot;kb2&quot;</span><span class="p">:</span> <span class="mf">20.2</span><span class="p">,</span>
      <span class="nt">&quot;kc2&quot;</span><span class="p">:</span> <span class="s2">&quot;vc2020&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="nt">&quot;ka1&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="nt">&quot;kb1&quot;</span><span class="p">:</span> <span class="mf">3.3</span><span class="p">,</span>
  <span class="nt">&quot;kc1&quot;</span><span class="p">:</span> <span class="s2">&quot;vc33&quot;</span><span class="p">,</span>
  <span class="nt">&quot;kd1&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;ka2&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
      <span class="nt">&quot;kb2&quot;</span><span class="p">:</span> <span class="mf">30.3</span><span class="p">,</span>
      <span class="nt">&quot;kc2&quot;</span><span class="p">:</span> <span class="s2">&quot;vc3030&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>可以看到这个JSON文件内容是有多层嵌套的，结构比之前那个CSV文件要复杂不少，而查询嵌套数据正是Drill的优势所在。</p>
<div class="highlight"><pre><span></span><span class="mi">0</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">drill</span><span class="o">:</span><span class="n">zk</span><span class="o">=</span><span class="n">local</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">dfs</span><span class="o">.</span><span class="err">`</span><span class="sr">/path/to/work/drill/data/</span><span class="n">test</span><span class="o">.</span><span class="na">json</span><span class="err">`</span><span class="o">;</span>
<span class="o">+------------+------------+------------+------------+</span>
<span class="o">|</span>    <span class="n">ka1</span>     <span class="o">|</span>    <span class="n">kb1</span>     <span class="o">|</span>    <span class="n">kc1</span>     <span class="o">|</span>    <span class="n">kd1</span>     <span class="o">|</span>
<span class="o">+------------+------------+------------+------------+</span>
<span class="o">|</span> <span class="mi">1</span>          <span class="o">|</span> <span class="mf">1.1</span>        <span class="o">|</span> <span class="n">vc11</span>       <span class="o">|</span> <span class="o">[{</span><span class="s2">&quot;ka2&quot;</span><span class="o">:</span><span class="mi">10</span><span class="o">,</span><span class="s2">&quot;kb2&quot;</span><span class="o">:</span><span class="mf">10.1</span><span class="o">,</span><span class="s2">&quot;kc2&quot;</span><span class="o">:</span><span class="s2">&quot;vc1010&quot;</span><span class="o">}]</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span>          <span class="o">|</span> <span class="mf">2.2</span>        <span class="o">|</span> <span class="n">vc22</span>       <span class="o">|</span> <span class="o">[{</span><span class="s2">&quot;ka2&quot;</span><span class="o">:</span><span class="mi">20</span><span class="o">,</span><span class="s2">&quot;kb2&quot;</span><span class="o">:</span><span class="mf">20.2</span><span class="o">,</span><span class="s2">&quot;kc2&quot;</span><span class="o">:</span><span class="s2">&quot;vc2020&quot;</span><span class="o">}]</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>          <span class="o">|</span> <span class="mf">3.3</span>        <span class="o">|</span> <span class="n">vc33</span>       <span class="o">|</span> <span class="o">[{</span><span class="s2">&quot;ka2&quot;</span><span class="o">:</span><span class="mi">30</span><span class="o">,</span><span class="s2">&quot;kb2&quot;</span><span class="o">:</span><span class="mf">30.3</span><span class="o">,</span><span class="s2">&quot;kc2&quot;</span><span class="o">:</span><span class="s2">&quot;vc3030&quot;</span><span class="o">}]</span> <span class="o">|</span>
<span class="o">+------------+------------+------------+------------+</span>
<span class="mi">3</span> <span class="n">rows</span> <span class="n">selected</span> <span class="o">(</span><span class="mf">0.098</span> <span class="n">seconds</span><span class="o">)</span>
</pre></div>


<p><code>select *</code>只查出第一层的数据，更深层的数据只以原本的JSON数据呈现出来，我们显然不应该只关心第一层的数据，具体怎么查完全随心所欲：</p>
<div class="highlight"><pre><span></span><span class="mi">0</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">drill</span><span class="o">:</span><span class="n">zk</span><span class="o">=</span><span class="n">local</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">sum</span><span class="o">(</span><span class="n">ka1</span><span class="o">),</span> <span class="n">avg</span><span class="o">(</span><span class="n">kd1</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">kb2</span><span class="o">)</span> <span class="n">from</span> <span class="n">dfs</span><span class="o">.</span><span class="err">`</span><span class="sr">/path/to/work/drill/data/</span><span class="n">test</span><span class="o">.</span><span class="na">json</span><span class="err">`</span><span class="o">;</span>
<span class="o">+------------+------------+</span>
<span class="o">|</span>   <span class="n">EXPR$0</span>   <span class="o">|</span>   <span class="n">EXPR$1</span>   <span class="o">|</span>
<span class="o">+------------+------------+</span>
<span class="o">|</span> <span class="mi">6</span>          <span class="o">|</span> <span class="mf">20.2</span>       <span class="o">|</span>
<span class="o">+------------+------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">selected</span> <span class="o">(</span><span class="mf">0.136</span> <span class="n">seconds</span><span class="o">)</span>
</pre></div>


<p>可以通过<code>kd1[0]</code>来访问嵌套到第二层的这个表。</p>
<div class="highlight"><pre><span></span><span class="mi">0</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">drill</span><span class="o">:</span><span class="n">zk</span><span class="o">=</span><span class="n">local</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">kc1</span><span class="o">,</span> <span class="n">kd1</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">kc2</span> <span class="n">from</span> <span class="n">dfs</span><span class="o">.</span><span class="err">`</span><span class="sr">/path/to/work/drill/data/</span><span class="n">test</span><span class="o">.</span><span class="na">json</span><span class="err">`</span> <span class="n">where</span> <span class="n">kd1</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">kb2</span> <span class="o">=</span> <span class="mf">10.1</span> <span class="n">and</span> <span class="n">ka1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">+------------+------------+</span>
<span class="o">|</span>    <span class="n">kc1</span>     <span class="o">|</span>   <span class="n">EXPR$1</span>   <span class="o">|</span>
<span class="o">+------------+------------+</span>
<span class="o">|</span> <span class="n">vc11</span>       <span class="o">|</span> <span class="n">vc1010</span>     <span class="o">|</span>
<span class="o">+------------+------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">selected</span> <span class="o">(</span><span class="mf">0.181</span> <span class="n">seconds</span><span class="o">)</span>
</pre></div>


<p>创建view：</p>
<div class="highlight"><pre><span></span><span class="mi">0</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">drill</span><span class="o">:</span><span class="n">zk</span><span class="o">=</span><span class="n">local</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">view</span> <span class="n">dfs</span><span class="o">.</span><span class="na">tmp</span><span class="o">.</span><span class="na">tmpview</span> <span class="k">as</span> <span class="n">select</span> <span class="n">kd1</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">kb2</span> <span class="n">from</span> <span class="n">dfs</span><span class="o">.</span><span class="err">`</span><span class="sr">/path/to/work/drill/data/</span><span class="n">test</span><span class="o">.</span><span class="na">json</span><span class="err">`</span><span class="o">;</span>
<span class="o">+------------+------------+</span>
<span class="o">|</span>     <span class="n">ok</span>     <span class="o">|</span>  <span class="n">summary</span>   <span class="o">|</span>
<span class="o">+------------+------------+</span>
<span class="o">|</span> <span class="kc">true</span>       <span class="o">|</span> <span class="n">View</span> <span class="s1">&#39;tmpview&#39;</span> <span class="n">created</span> <span class="n">successfully</span> <span class="k">in</span> <span class="s1">&#39;dfs.tmp&#39;</span> <span class="n">schema</span> <span class="o">|</span>
<span class="o">+------------+------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">selected</span> <span class="o">(</span><span class="mf">0.055</span> <span class="n">seconds</span><span class="o">)</span>

<span class="mi">0</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">drill</span><span class="o">:</span><span class="n">zk</span><span class="o">=</span><span class="n">local</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">dfs</span><span class="o">.</span><span class="na">tmp</span><span class="o">.</span><span class="na">tmpview</span><span class="o">;</span>
<span class="o">+------------+</span>
<span class="o">|</span>   <span class="n">EXPR$0</span>   <span class="o">|</span>
<span class="o">+------------+</span>
<span class="o">|</span> <span class="mf">10.1</span>       <span class="o">|</span>
<span class="o">|</span> <span class="mf">20.2</span>       <span class="o">|</span>
<span class="o">|</span> <span class="mf">30.3</span>       <span class="o">|</span>
<span class="o">+------------+</span>
<span class="mi">3</span> <span class="n">rows</span> <span class="n">selected</span> <span class="o">(</span><span class="mf">0.193</span> <span class="n">seconds</span><span class="o">)</span>
</pre></div>


<p>可以把嵌套的第二层表打平（整合kd1[0]..kd1[n]）：</p>
<div class="highlight"><pre><span></span><span class="mi">0</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">drill</span><span class="o">:</span><span class="n">zk</span><span class="o">=</span><span class="n">local</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">kddb</span><span class="o">.</span><span class="na">kdtable</span><span class="o">.</span><span class="na">kc2</span> <span class="n">from</span> <span class="o">(</span><span class="n">select</span> <span class="n">flatten</span><span class="o">(</span><span class="n">kd1</span><span class="o">)</span> <span class="n">kdtable</span> <span class="n">from</span> <span class="n">dfs</span><span class="o">.</span><span class="err">`</span><span class="sr">/path/to/work/drill/data/</span><span class="n">test</span><span class="o">.</span><span class="na">json</span><span class="err">`</span><span class="o">)</span> <span class="n">kddb</span><span class="o">;</span>
<span class="o">+------------+</span>
<span class="o">|</span>   <span class="n">EXPR$0</span>   <span class="o">|</span>
<span class="o">+------------+</span>
<span class="o">|</span> <span class="n">vc1010</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">vc2020</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">vc3030</span>     <span class="o">|</span>
<span class="o">+------------+</span>
<span class="mi">3</span> <span class="n">rows</span> <span class="n">selected</span> <span class="o">(</span><span class="mf">0.083</span> <span class="n">seconds</span><span class="o">)</span>
</pre></div>


<p>使用细节上和mysql还是有所不同的，另外涉及到多层表的复杂逻辑，要想用得得心应手还需要仔细阅读官方文档并多多练习。这次先走马观花了，之后会深入了解语法层面的特性。</p>
<h2>参考</h2>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/DRILL/Apache+Drill+in+10+Minutes">Apache Drill in 10 Minutes</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/DRILL/Analyzing+Yelp+JSON+Data+with+Apache+Drill">Analyzing Yelp JSON Data with Apache Drill</a></li>
</ul>
                </div>
            </div>
        </div>
    </article>
</section>
<footer>
    <div class="row">
        <div class="col-lg-9 text-center">
            <p><small>
                Built by <a href="http://docs.getpelican.com/en/latest">Pelican</a> / <a href="https://github.com/ingwinlu/pelican-twitchy">pelican-twitchy</a>
                &middot;
                &copy; 2017 goreliu
            </small></p>
        </div>
    </div>
</footer>            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->
    <!-- jQuery Version 1.11.2 -->
    <script src="/theme/js/jquery-1.11.2.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>
    <!-- twitchy Script -->
    <script src="/theme/js/pelican_twitchy.min.js"></script>

</body>
</html>